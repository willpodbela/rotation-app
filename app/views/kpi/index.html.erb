<%= link_to("Back to Admin Home", admin_path, :class => 'back-link') %></br>

<div class="kpi index">
  <h2>Inventory KPIs</h2>
  
  <h3>Product Availability</h3>
  <table class="listing admin_table" summary="Currently available SKUs when filtering by size">
    <tr class="header">
      <th>Size Filter</th>
      <th>Displayed SKUs</th>
      <th>Dist. of Paying Customers</th>
    </tr>
    <tr>
      <td>-</td>
      <td><%= @visible_count %></td>
    </tr>
    <% Unit.sizes.keys.each do |size| %>
    <tr>
      <td><%= size %></td>
      <td><%= @inventory.unique_available_item_count(size).keys.count %></td>
      <td><%= number_with_precision(@customer_sizes[size], :precision => 2) %></td>
    </tr>
    <% end %>
    <tr>
      <td>All</td>
      <td><%= @inventory.unique_available_item_count.keys.count %></td>
    </tr>
  </table>
  
  <h3>Penetration</h3>
  <%= form_tag('index', :method => "get") do %>
    <%= select_tag "slice_by", options_from_collection_for_select(@slice_options, "to_s", "titleize", @slice_by), include_blank: true, class: "width200" %>
    <%= submit_tag 'Filter' %>
  <% end %>
  <p class="top10"><i>Total days rented / total days available across all the units. Visible items only.</i></p>
  <table class="listing admin_table has_graph" summary="Unit list">
    <tr class="header">
      <th><%= @slice_by.titleize %></th>
      <th>90-day</th>
      <th class="black-border-right">30-day</th>
      <th>Item Count</th>
      <th>Unit Count</th>
      <th>Rental Count</th>
      <th>Date Newest Item</th>
    </tr>
    <% @penetration_items.each do |kv_array_pair| %>
    <tr>
      <td><%= kv_array_pair[0] || "*No Value" %></td>
      <td><%= number_with_precision((kv_array_pair[1].sum {|e| e.cum_days_rented(Time.zone.now-90.day) }) * 100 / ((kv_array_pair[1].sum {|e| e.cum_days_units_in_service(Time.zone.now-90.day)}).to_f.nonzero? || 1), :precision => 2) %>%</td>
      <td class="black-border-right"><%= number_with_precision((kv_array_pair[1].sum {|e| e.cum_days_rented(Time.zone.now-30.day) }) * 100 / ((kv_array_pair[1].sum {|e| e.cum_days_units_in_service(Time.zone.now-30.day)}).to_f.nonzero? || 1), :precision => 2) %>%</td>
      <td><%= kv_array_pair[1].size %></td>
      <td><%= kv_array_pair[1].sum { |e| e.units.size } %></td>
      <td><%= kv_array_pair[1].sum { |e| e.not_cancelled_reservations.size } %></td>
      <td><%= kv_array_pair[1].max_by(&:created_at).created_at.to_date %></td>
    </tr>
    <% end %>
  </table>
  <div class="admin_table_graph">
    <%= javascript_include_tag "chartkick" %>
    <%= line_chart @graph_hash, xtitle: "Days (Trailing)", ytitle: "Penetration", suffix: "%", precision: 4  %>
  </div>
</div>
